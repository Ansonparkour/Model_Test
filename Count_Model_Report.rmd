---
title: "Count Model Report"
author: "Sean Zhang"
date: "June 14, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Outline
Count data often analyzed incorrectly with OLS regression, then we introduce count model. 

* Poisson Regression
* Negative Binomial Regression
* Zero-Inflated Count Models
    + Zero-inflated Poisson
    + Zero-inflated Negative Binomial
* Zero-Truncated Count Models
    + Zero-truncated Poisson
    + Zero-truncated Negative Binomial


```{r load library, include = FALSE}
library(pscl)
library(MASS)
library(VGAM)
```

### Create random dataset 
create a fake random 1000 * 5 matrix corresponding to 50 features with 1000 observations

```{r create_dataset}
set.seed(2016)
test_data <-  data.frame(matrix( rnorm(100000*50,mean=0,sd=1), 100000, 50)) 

#intercept 
test_data$X1 <- sample(1,100000, replace = T)
#binary 
test_data$X2 <- sample(0:1,100000, replace = T)
#ordinal
test_data$X3 <- sample(1:3,100000, replace = T)
#4 level nominal
test_data$X4 <- sample(1:4,100000, replace = T)
#count data, with 90% zero value
test_data$X5 <- sample(c(0,1),100000,  replace = T, prob = c(0.9,0.1))
```


### Preview the test dataset

Look at the first two row of the test datase 

```{r test_data, echo=FALSE}
head(test_data,2)
```


### Poission Regression
Poisson regression models provide a standard framework for the analysis of count data. 

Poisson distribution is discrete and non-negative values, so we use poission regression for the count data. Poisson regression assume the mean and the varience are equal, for the count model with different means and variances, we could use negative binomial regression, which will be discussed later. 

```{r poission_model}
poisson_glm <- function(){
    system.time(
        model_8 <- glm(X5 ~ X6 +X7,  data = test_data, family = poisson() )
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_poission, echo = FALSE}
t_poisson_glm <- poisson_glm()
t_poisson_glm
```

### Negative Binomial Model
The negative binomial distribution is a form of the poisson distribution in which the distribution's parameter is itself considered a random variable. 

A negative binomial model proved to fit well for the count data which majority of individuals in the data set perpetrated 0 times, but a few individuals perpetrated many times, the variance was over 6 times larger than the mean.

*require* `library(MASS)`

```{r negative_binomial_model }
negbinomial <- function(){
    system.time(
        model <-  glm.nb(X5 ~ X6 +X7, data = test_data)
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_nb, echo = FALSE, warning=FALSE}
t_negbinomial <- negbinomial()
t_negbinomial
```

### Zero-inflated Poisson Regression
For the analysis of count data, ZIP models are designed to deal with situations where there is an "excessive" number of individuals with a count of 0. Poisson model assumes that the conditional variance of the dependent variable is equal to the conditional mean. In most count data sets, the conditional variance is greater than the conditional mean, often much greater, a phenomenon known as overdispersion. 

In cases of overdispersion, the ZIP model typically fits better than a standard Poisson model, but the negative binomial model fits much better than a ZIP model, which is also allow overdispersion. 

*require* `library(pscl)`, non-negative response.

*reference* http://statisticalhorizons.com/zero-inflated-models

```{r zip}
zeroinf_poi <- function(){
    system.time(
        model_10 <- zeroinfl(X5 ~ X6 +X7, data = test_data, dist = 'poisson')
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_zip, echo = FALSE, warning=FALSE}
t_zeroinf_poi <- zeroinf_poi()
t_zeroinf_poi
```


### Zero-inflated Negative Binomial Model
Zero-inflated negative binomial regression is for modeling count variables with excessive zeros and it is usually for overdispersed count outcome variables. Furthermore, theory suggests that the excess zeros are generated by a separate process from the count values and that the excess zeros can be modeled independently. 

Usually, Zero-inflated Negative Binomial model is beter than negative binomial model. 

*require* `library(pscl)`, non-negative response.

```{r zinb}
zeroinf_nb <- function(){
    system.time(
        model_11 <- zeroinfl(X5 ~ X6 +X7, data = test_data, dist = 'negbin' )
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_zinb, echo = FALSE, warning=FALSE}
t_zeroinf_nb <- zeroinf_nb()
t_zeroinf_nb
```

### Zero-truncated Poisson Regression
The count data is Poisson-like but zeroes removed. Response Y is truncated, because observe X is just for the observations that Y>0. That is to say, we do not have full sample for (Y,X).

Zero data removed is the key difference between zero-inflated model and zero-truncted model.  


*require* `library(VGAM)`, postive response.

```{r zerotrunc_poi}
zerotrunc_poi <- function(){
    system.time(
        model_12 <- vglm(X4 ~ X6 +X7, data = test_data, family = pospoisson())
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_zerotrunc_poi, echo = FALSE, warning=FALSE}
t_zerotrunc_poi <- zerotrunc_poi()
t_zerotrunc_poi
```


### Zero-truncated Negative Binomial

*require* `library(VGAM)`, postive response.

```{r zerotrunc_nb}
zerotrunc_nb <- function(){
    system.time(
        model_13 <- vglm(X4 ~ X6 +X7, data = test_data, family = posnegbinomial())
    )
}
```

Using `system.time()` to test the excution time of running model in the fake dataset. 

```{r excution_zerotrunc_nb, echo = FALSE, warning=FALSE}
t_zerotrunc_nb <- zerotrunc_nb()
t_zerotrunc_nb
```



### Execution Comparision of Count model 
Generally, as we can see, execution time for all kind of poisson-based model is much shorter. Poisson model cannot deal with count data with excessive number of zero, so we use zero-inflated and zero-truncted poisson model substituted.   

```{r comparision, echo=FALSE}
exe_time <- rbind(t_poisson_glm,t_negbinomial,t_zeroinf_poi,t_zeroinf_nb,t_zerotrunc_poi,t_zerotrunc_nb)
exe_time <- as.data.frame(exe_time) 
#plot the excution time
par(las=2) # make label text perpendicular to axis
par(mar=c(5,8,4,3)) # increase y-axis margin.
p <- barplot(
    (exe_time$elapsed),
    horiz=TRUE,
    xlab = "Execution total time",
    col=c("blue","red","blue","red","blue","red"),
    names.arg = c("poisson_glm", "negbinomial", "zeroinf_poi ","zeroinf_nb ","zerotrunc_poi","zerotrunc_nb"),
    cex.names=0.7
)
text(x = exe_time$elapsed + 1.5, y = p, labels = round(exe_time$elapsed, 2),xpd = T) 
```











